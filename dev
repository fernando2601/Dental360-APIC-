#!/usr/bin/env node

const express = require('express');
const path = require('path');
const fs = require('fs');

const app = express();
const port = process.env.PORT || 5000;

// Middleware
app.use(express.json());
app.use(express.static(path.join(__dirname, 'src')));
app.use(express.static(path.join(__dirname, 'frontend')));

// API Routes for mock backend
app.get('/api/dashboard/stats', (req, res) => {
  res.json({
    totalClients: 150,
    appointmentsToday: 8,
    monthlyRevenue: 45000,
    totalServices: 25
  });
});

app.get('/api/appointments/upcoming', (req, res) => {
  res.json([
    {
      id: 1,
      clientName: "Maria Silva",
      serviceName: "Limpeza Dental",
      dateTime: new Date().toISOString(),
      status: "Confirmado"
    },
    {
      id: 2,
      clientName: "JoÃ£o Santos",
      serviceName: "Clareamento Dental", 
      dateTime: new Date(Date.now() + 3600000).toISOString(),
      status: "Pendente"
    }
  ]);
});

app.get('/api/database/status', (req, res) => {
  res.json({
    PostgreSQL: {
      Available: true,
      IsPrimary: true,
      ConnectionString: "PostgreSQL Connected"
    },
    SqlServer: {
      Available: false,
      IsPrimary: false,
      ConnectionString: "Not configured"
    },
    Recommendations: ["Sistema funcionando com PostgreSQL"]
  });
});

// Serve Angular app
app.get('*', (req, res) => {
  // Try to serve from frontend directory first, then from src
  const frontendPath = path.join(__dirname, 'frontend', 'index.html');
  const srcPath = path.join(__dirname, 'src', 'index.html');
  const demoPath = path.join(__dirname, 'demo.html');
  
  if (fs.existsSync(frontendPath)) {
    res.sendFile(frontendPath);
  } else if (fs.existsSync(srcPath)) {
    res.sendFile(srcPath);
  } else if (fs.existsSync(demoPath)) {
    res.sendFile(demoPath);
  } else {
    res.status(404).send('Application not found');
  }
});

app.listen(port, '0.0.0.0', () => {
  console.log(`DentalSpa server running on http://0.0.0.0:${port}`);
  console.log('Frontend Angular restaurado com sucesso!');
});